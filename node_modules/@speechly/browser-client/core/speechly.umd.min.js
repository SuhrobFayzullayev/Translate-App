!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Speechly={})}(this,(function(t){"use strict";const e=new Error("Current device does not support microphone API"),i=new Error("AppId changed without project login"),s=16e3;class n{constructor(t,e){this.isFinalized=!1,this.words=[],this.entities=new Map,this.intent={intent:"",isFinal:!1},this.contextId=t,this.id=e}toSegment(){let t=0;const e=new Array(this.entities.size);return this.entities.forEach((i=>{e[t]=i,t++})),{id:this.id,contextId:this.contextId,isFinal:this.isFinalized,words:this.words,entities:e,intent:this.intent}}toString(){const t=this.toSegment(),e=t.words.filter((t=>t.value)),i=Object.assign(Object.assign({},t),{words:e});return JSON.stringify(i,null,2)}updateTranscript(t){return t.forEach((t=>{this.isFinalized&&!t.isFinal||(this.words[t.index]=t)})),this}updateEntities(t){return t.forEach((t=>{this.isFinalized&&!t.isFinal||this.entities.set(this.entityMapKey(t),t)})),this}updateIntent(t){return this.isFinalized&&!t.isFinal||(this.intent=t),this}finalize(){return this.entities.forEach(((t,e)=>{t.isFinal||this.entities.delete(e)})),this.words=this.words.filter((t=>t.isFinal)),this.intent.isFinal||(this.intent.intent="",this.intent.isFinal=!0),this.isFinalized=!0,this}entityMapKey(t){return`${t.startPosition.toString()}:${t.endPosition.toString()}`}}function o(t,e,i,s){return new(i||(i=Promise))((function(n,o){function a(t){try{c(s.next(t))}catch(t){o(t)}}function d(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,d)}c((s=s.apply(t,e||[])).next())}))}const a=new Error("Microphone is not initialized"),d=new Error("Microphone is already initialized"),c=new Error("Microphone consent is not given");var l,r,h,p;t.AudioSourceState=void 0,(l=t.AudioSourceState||(t.AudioSourceState={})).NoAudioConsent="NoAudioConsent",l.NoBrowserSupport="NoBrowserSupport",l.Stopped="Stopped",l.Starting="Starting",l.Started="Started";t.WebsocketResponseType=void 0,(r=t.WebsocketResponseType||(t.WebsocketResponseType={})).Started="started",r.Stopped="stopped",r.SegmentEnd="segment_end",r.Transcript="transcript",r.Entity="entity",r.Intent="intent",r.TentativeTranscript="tentative_transcript",r.TentativeEntities="tentative_entities",r.TentativeIntent="tentative_intent",t.WorkerSignal=void 0,(h=t.WorkerSignal||(t.WorkerSignal={})).Opened="WEBSOCKET_OPEN",h.Closed="WEBSOCKET_CLOSED",h.AudioProcessorReady="SOURCE_SAMPLE_RATE_SET_SUCCESS",h.VadSignalHigh="VadSignalHigh",h.VadSignalLow="VadSignalLow",h.RequestContextStart="RequestContextStart",t.ControllerSignal=void 0,(p=t.ControllerSignal||(t.ControllerSignal={})).connect="connect",p.initAudioProcessor="initAudioProcessor",p.adjustAudioProcessor="adjustAudioProcessor",p.SET_SHARED_ARRAY_BUFFERS="SET_SHARED_ARRAY_BUFFERS",p.CLOSE="CLOSE",p.START_CONTEXT="START_CONTEXT",p.SWITCH_CONTEXT="SWITCH_CONTEXT",p.STOP_CONTEXT="STOP_CONTEXT",p.AUDIO="AUDIO",p.startStream="startStream",p.stopStream="stopStream",p.setContextOptions="setContextOptions";const u=new Error("Current device does not support storage API"),b=new Error("Requested key was not present in storage"),m={connect:!0,apiUrl:"https://api.speechly.com",sampleRate:s,debug:!1,logSegments:!1,frameMillis:30,historyFrames:5},Z={enabled:!1,controlListening:!0,signalToNoiseDb:3,noiseGateDb:-24,noiseLearnHalftimeMillis:400,signalSearchFrames:5,signalActivation:.7,signalRelease:.2,signalSustainMillis:3e3},y={preserveSegments:!1,sampleRate:s,immediate:!1,autoStarted:!1};var G;t.DecoderState=void 0,(G=t.DecoderState||(t.DecoderState={}))[G.Failed=0]="Failed",G[G.Disconnected=1]="Disconnected",G[G.Connected=2]="Connected",G[G.Active=3]="Active";class v extends Array{addEventListener(t){this.push(t)}removeEventListener(t){const e=this.findIndex((e=>e===t));e>=0&&this.splice(e,1)}}class W{constructor(){this.stateChangeCbs=new v,this.transcriptCbs=new v,this.entityCbs=new v,this.intentCbs=new v,this.segmentChangeCbs=new v,this.tentativeTranscriptCbs=new v,this.tentativeEntityCbs=new v,this.tentativeIntentCbs=new v,this.contextStartedCbs=new v,this.contextStoppedCbs=new v,this.onVadStateChange=new v}}const X=new Error("BrowserClient already started"),R=new Error("BrowserClient already stopped");function S(t){var e;return null!==(e=V.get(t))&&void 0!==e?e:"unknown"}const V=new Map([[t.DecoderState.Failed,"Failed"],[t.DecoderState.Disconnected,"Disconnected"],[t.DecoderState.Connected,"Connected"],[t.DecoderState.Active,"Active"]]);var C,g=new Uint8Array(16);function z(){if(!C&&!(C="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return C(g)}var N=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Y(t){return"string"==typeof t&&N.test(t)}for(var T=[],x=0;x<256;++x)T.push((x+256).toString(16).substr(1));function L(t,e,i){var s=(t=t||{}).random||(t.rng||z)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,e){i=i||0;for(var n=0;n<16;++n)e[i+n]=s[n];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(T[t[e+0]]+T[t[e+1]]+T[t[e+2]]+T[t[e+3]]+"-"+T[t[e+4]]+T[t[e+5]]+"-"+T[t[e+6]]+T[t[e+7]]+"-"+T[t[e+8]]+T[t[e+9]]+"-"+T[t[e+10]]+T[t[e+11]]+T[t[e+12]]+T[t[e+13]]+T[t[e+14]]+T[t[e+15]]).toLowerCase();if(!Y(i))throw TypeError("Stringified UUID is invalid");return i}(s)}var f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},F={exports:{}};
/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */
!function(t,e){!function(i){var s=e,n=t&&t.exports==s&&t,o="object"==typeof f&&f;o.global!==o&&o.window!==o||(i=o);var a=function(t){this.message=t};(a.prototype=new Error).name="InvalidCharacterError";var d=function(t){throw new a(t)},c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=/[\t\n\f\r ]/g,r={encode:function(t){t=String(t),/[^\0-\xFF]/.test(t)&&d("The string to be encoded contains characters outside of the Latin1 range.");for(var e,i,s,n,o=t.length%3,a="",l=-1,r=t.length-o;++l<r;)e=t.charCodeAt(l)<<16,i=t.charCodeAt(++l)<<8,s=t.charCodeAt(++l),a+=c.charAt((n=e+i+s)>>18&63)+c.charAt(n>>12&63)+c.charAt(n>>6&63)+c.charAt(63&n);return 2==o?(e=t.charCodeAt(l)<<8,i=t.charCodeAt(++l),a+=c.charAt((n=e+i)>>10)+c.charAt(n>>4&63)+c.charAt(n<<2&63)+"="):1==o&&(n=t.charCodeAt(l),a+=c.charAt(n>>2)+c.charAt(n<<4&63)+"=="),a},decode:function(t){var e=(t=String(t).replace(l,"")).length;e%4==0&&(e=(t=t.replace(/==?$/,"")).length),(e%4==1||/[^+a-zA-Z0-9/]/.test(t))&&d("Invalid character: the string to be decoded is not correctly encoded.");for(var i,s,n=0,o="",a=-1;++a<e;)s=c.indexOf(t.charAt(a)),i=n%4?64*i+s:s,n++%4&&(o+=String.fromCharCode(255&i>>(-2*n&6)));return o},version:"0.1.0"};if(s&&!s.nodeType)if(n)n.exports=r;else for(var h in r)r.hasOwnProperty(h)&&(s[h]=r[h]);else i.base64=r}(f)}(F,F.exports);function w(t,e,i,s,n=Date.now){const o=function(t){const e=t.split(".")[1];let i;try{i=JSON.parse(F.exports.decode(e))}catch(t){throw new Error("Error decoding Speechly token!")}return{appId:i.appId,projectId:i.projectId,deviceId:i.deviceId,configId:i.configId,scopes:i.scope.split(" "),issuer:i.iss,audience:i.aud,expiresAtMs:1e3*i.exp}}(t);return!(o.expiresAtMs-n()<36e5)&&(o.appId===i&&o.projectId===e&&o.deviceId===s)}class I{constructor(){this.startCbs=[],this.stopCbs=[],this.onResponseCb=()=>{},this.onCloseCb=()=>{},this.onWebsocketMessage=e=>{const i=e.data;switch(i.type){case t.WorkerSignal.Opened:null!=this.resolveInitialization&&this.resolveInitialization();break;case t.WorkerSignal.Closed:this.onCloseCb({code:e.data.code,reason:e.data.reason,wasClean:e.data.wasClean});break;case t.WorkerSignal.AudioProcessorReady:null!=this.resolveSourceSampleRateSet&&this.resolveSourceSampleRateSet();break;case t.WebsocketResponseType.Started:this.onResponseCb(i),this.startCbs.forEach((t=>{try{t(void 0,i.audio_context)}catch(t){console.error('[SpeechlyClient] Error while invoking "onStart" callback:',t)}})),this.startCbs.length=0;break;case t.WebsocketResponseType.Stopped:this.onResponseCb(i),this.stopCbs.forEach((t=>{try{t(void 0,i.audio_context)}catch(t){console.error('[SpeechlyClient] Error while invoking "onStop" callback:',t)}})),this.stopCbs.length=0;break;default:this.onResponseCb(i)}},this.worker=new"Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwp2YXIgd29ya2VyX2NvZGU9ZnVuY3Rpb24odCl7InVzZSBzdHJpY3QiO2NsYXNzIGV7c3RhdGljIGRvd25zYW1wbGUodCxlLHM9MCxpPS0xLG89MCxhPS0xKXtpZihpPDAmJihpPXQubGVuZ3RoLXMpLGE8MCYmKGE9ZS5sZW5ndGgtbyksYT5pKXRocm93IG5ldyBFcnJvcihgQ2FuJ3QgZG93bnNhbXBsZTogc291cmNlIGFycmF5IGxlbmd0aCAoJHtpfSkgaXMgc2hvcnRlciB0aGFuIGRlc3RpbmF0aW9uICgke2F9KWApO2lmKDA9PT1hKXRocm93IG5ldyBFcnJvcihgQ2FuJ3QgZG93bnNhbXBsZTogc291cmNlIGFycmF5IGxlbmd0aCAoJHtpfSkgY2FuJ3QgYmUgZG93bnNhbXBsZWQgdG8gemVyby1sZW5ndGggZGVzdGluYXRpb24uYCk7aWYoMD09PWkpdGhyb3cgbmV3IEVycm9yKCJDYW4ndCBkb3duc2FtcGxlOiBzb3VyY2UgcmFuZ2UgY2FuJ3QgYmUgemVybyBsZW5ndGguIik7aWYoMT09PWkpcmV0dXJuIHZvaWQoZVswXT10WzBdKTtsZXQgcj0wO2NvbnN0IG49KGEtMSkvKGktMSk7bGV0IGg9MCxkPTA7Y29uc3QgbD1zK2k7Zm9yKDtzPGw7cysrKXtjb25zdCBpPS41LU1hdGguYWJzKHIpO2grPXRbc10qaSxkKz1pLHIrPW4scj49LjUmJihyLT0xLGVbbysrXT1oL2QsaD0wLGQ9MCl9ZD4wJiYoZVtvKytdPWgvZCl9c3RhdGljIGdldEVuZXJneSh0LGU9MCxzPS0xKXtpZihzPDAmJihzPXQubGVuZ3RoLWUpLHM8PTApcmV0dXJuIDA7Y29uc3QgaT1lK3M7bGV0IG89MDtmb3IoO2U8aTtlKyspbys9dFtlXSp0W2VdO3JldHVybiBNYXRoLnNxcnQoby9zKX1zdGF0aWMgZ2V0QXVkaW9QZWFrKHQsZT0wLHM9LTEpe2lmKHM8MCYmKHM9dC5sZW5ndGgtZSksczw9MClyZXR1cm4gMDtjb25zdCBpPWUrcztsZXQgbz0wO2Zvcig7ZTxpO2UrKyl0W2VdPm8mJihvPXRbZV0pO3JldHVybiBvfXN0YXRpYyBjb252ZXJ0SW50MTZUb0Zsb2F0KHQsZSxzPTAsaT0tMSxvPTApe2k8MCYmKGk9dC5sZW5ndGgvMi1zKTtjb25zdCBhPU1hdGgubWluKHQubGVuZ3RoLzItcyxlLmxlbmd0aC1vKTtpZigoaT1NYXRoLm1pbihpLGEpKTw9MClyZXR1cm4gMDtsZXQgcj0yKnM7Y29uc3Qgbj1yKzIqaTtmb3IoO3I8bjspZVtvKytdPSh0W3IrK10rKHRbcisrXTw8OCkpLzMyNzY3O3JldHVybiBpfXN0YXRpYyBjb252ZXJ0RmxvYXRUb0ludDE2KHQsZSxzPTAsaT0tMSxvPTApe2k8MCYmKGk9dC5sZW5ndGgtcyk7Y29uc3QgYT1zK2k7Zm9yKDtzPGE7KWVbbysrXT1+figzMjc2Nyp0W3MrK10pfXN0YXRpYyBlbmVyZ3lUb0RiKHQpe3JldHVybiAxMCpNYXRoLmxvZyh0KS9lLkxPR18yX1BMVVNfTE9HXzV9c3RhdGljIGRiVG9FbmVyZ3kodCl7cmV0dXJuIE1hdGgucG93KDEwLHQvMTApfX1lLkxPR18yX1BMVVNfTE9HXzU9TWF0aC5sb2coMikrTWF0aC5sb2coNSk7Y2xhc3Mgc3tjb25zdHJ1Y3Rvcih0LGUscyxpKXt0aGlzLmlzU2VuZGluZz0hMSx0aGlzLnN0cmVhbVNhbXBsZVBvcz0wLHRoaXMuc2FtcGxlc1NlbnQ9MCx0aGlzLnV0dGVyYW5jZVNlcmlhbD0tMSx0aGlzLm9uU2VuZEF1ZGlvPSh0LGUscyk9Pnt9LHRoaXMub25WYWRTdGF0ZUNoYW5nZT10PT57fSx0aGlzLmlucHV0U2FtcGxlUmF0ZT0xNmUzLHRoaXMuaW50ZXJuYWxTYW1wbGVSYXRlPTE2ZTMsdGhpcy5oaXN0b3J5RnJhbWVzPTUsdGhpcy5mcmFtZU1pbGxpcz0zMCx0aGlzLmN1cnJlbnRGcmFtZU51bWJlcj0wLHRoaXMuZnJhbWVTYW1wbGVQb3M9MCx0aGlzLnN0cmVhbUZyYW1lUG9zPTAsdGhpcy53YXNTaWduYWxEZXRlY3RlZD0hMSx0aGlzLmlucHV0U2FtcGxlUmF0ZT10LHRoaXMuaW50ZXJuYWxTYW1wbGVSYXRlPWUsdGhpcy5mcmFtZU1pbGxpcz1zLHRoaXMuaGlzdG9yeUZyYW1lcz1pLHRoaXMuZnJhbWVTYW1wbGVzPX5+KHRoaXMuaW50ZXJuYWxTYW1wbGVSYXRlKnRoaXMuZnJhbWVNaWxsaXMvMWUzKSx0aGlzLnNhbXBsZVJpbmdCdWZmZXI9bmV3IEZsb2F0MzJBcnJheSh0aGlzLmZyYW1lU2FtcGxlcyp0aGlzLmhpc3RvcnlGcmFtZXMpfXByb2Nlc3NBdWRpbyh0LHM9MCxpPS0xLG89ITEpe2lmKGk8MCYmKGk9dC5sZW5ndGgpLDA9PT1pKXJldHVybiB2b2lkKG8mJnRoaXMucHJvY2Vzc0VvcygpKTtsZXQgYT1zO2NvbnN0IHI9cytpO2Zvcig7YTxyOyl7Y29uc3Qgcz10aGlzLmN1cnJlbnRGcmFtZU51bWJlcip0aGlzLmZyYW1lU2FtcGxlcztpZih0aGlzLmlucHV0U2FtcGxlUmF0ZT09PXRoaXMuaW50ZXJuYWxTYW1wbGVSYXRlKXtjb25zdCBlPU1hdGgubWluKHItYSx0aGlzLmZyYW1lU2FtcGxlcy10aGlzLmZyYW1lU2FtcGxlUG9zKSxpPXRoaXMuZnJhbWVTYW1wbGVQb3MrZTtmb3IoO3RoaXMuZnJhbWVTYW1wbGVQb3M8aTspdGhpcy5zYW1wbGVSaW5nQnVmZmVyW3MrdGhpcy5mcmFtZVNhbXBsZVBvcysrXT10W2ErK119ZWxzZXtjb25zdCBpPTEqdGhpcy5pbnB1dFNhbXBsZVJhdGUvdGhpcy5pbnRlcm5hbFNhbXBsZVJhdGUsbz1NYXRoLm1pbihyLWEsTWF0aC5yb3VuZChpKih0aGlzLmZyYW1lU2FtcGxlcy10aGlzLmZyYW1lU2FtcGxlUG9zKSkpLG49TWF0aC5taW4oTWF0aC5yb3VuZCgoci1hKS9pKSx0aGlzLmZyYW1lU2FtcGxlcy10aGlzLmZyYW1lU2FtcGxlUG9zKTtuPjAmJmUuZG93bnNhbXBsZSh0LHRoaXMuc2FtcGxlUmluZ0J1ZmZlcixhLG8scyt0aGlzLmZyYW1lU2FtcGxlUG9zLG4pLGErPW8sdGhpcy5mcmFtZVNhbXBsZVBvcys9bn1jb25zdCBpPWE9PT1yJiZvO2lmKHRoaXMuZnJhbWVTYW1wbGVQb3M9PT10aGlzLmZyYW1lU2FtcGxlc3x8aSl7Y29uc3QgdD1pP3RoaXMuZnJhbWVTYW1wbGVQb3M6dGhpcy5mcmFtZVNhbXBsZXM7aWYodGhpcy5wcm9jZXNzRnJhbWUodGhpcy5zYW1wbGVSaW5nQnVmZmVyLHMsdCxpKSx0aGlzLmlzU2VuZGluZyl7aWYoMD09PXRoaXMuc2FtcGxlc1NlbnQpe2NvbnN0IHQ9TWF0aC5taW4odGhpcy5zdHJlYW1GcmFtZVBvcyx0aGlzLmhpc3RvcnlGcmFtZXMtMSk7bGV0IGU9KHRoaXMuY3VycmVudEZyYW1lTnVtYmVyK3RoaXMuaGlzdG9yeUZyYW1lcy10KSV0aGlzLmhpc3RvcnlGcmFtZXM7Zm9yKDtlIT09dGhpcy5jdXJyZW50RnJhbWVOdW1iZXI7KXRoaXMub25TZW5kQXVkaW8odGhpcy5zYW1wbGVSaW5nQnVmZmVyLGUqdGhpcy5mcmFtZVNhbXBsZXMsdGhpcy5mcmFtZVNhbXBsZXMpLHRoaXMuc2FtcGxlc1NlbnQrPXRoaXMuZnJhbWVTYW1wbGVzLGU9KGUrMSkldGhpcy5oaXN0b3J5RnJhbWVzfXRoaXMub25TZW5kQXVkaW8odGhpcy5zYW1wbGVSaW5nQnVmZmVyLHMsdCksdGhpcy5zYW1wbGVzU2VudCs9dH1pPyh0aGlzLnN0cmVhbVNhbXBsZVBvcys9dCx0aGlzLnByb2Nlc3NFb3MoKSk6dGhpcy5mcmFtZVNhbXBsZVBvcz09PXRoaXMuZnJhbWVTYW1wbGVzJiYodGhpcy5mcmFtZVNhbXBsZVBvcz0wLHRoaXMuc3RyZWFtRnJhbWVQb3MrPTEsdGhpcy5zdHJlYW1TYW1wbGVQb3MrPXQsdGhpcy5jdXJyZW50RnJhbWVOdW1iZXI9KHRoaXMuY3VycmVudEZyYW1lTnVtYmVyKzEpJXRoaXMuaGlzdG9yeUZyYW1lcyl9dGhpcy52YWQmJih0aGlzLndhc1NpZ25hbERldGVjdGVkPXRoaXMudmFkLmlzU2lnbmFsRGV0ZWN0ZWQpfX1zZXRTZW5kQXVkaW8odCl7dGhpcy5pc1NlbmRpbmc9dCx0JiYodGhpcy5zYW1wbGVzU2VudD0wLHRoaXMudXR0ZXJhbmNlU2VyaWFsKyspfXJlc2V0KHQpe3ZhciBlO3RoaXMuaXNTZW5kaW5nPSExLHRoaXMuc3RyZWFtRnJhbWVQb3M9MCx0aGlzLnN0cmVhbVNhbXBsZVBvcz0wLHRoaXMuZnJhbWVTYW1wbGVQb3M9MCx0aGlzLmN1cnJlbnRGcmFtZU51bWJlcj0wLHRoaXMudXR0ZXJhbmNlU2VyaWFsPS0xLHQmJih0aGlzLmlucHV0U2FtcGxlUmF0ZT10KSx0aGlzLndhc1NpZ25hbERldGVjdGVkPSExLG51bGw9PT0oZT10aGlzLnZhZCl8fHZvaWQgMD09PWV8fGUucmVzZXRWQUQoKX1nZXRTdHJlYW1Qb3NpdGlvbigpe3JldHVybiBNYXRoLnJvdW5kKHRoaXMuc3RyZWFtU2FtcGxlUG9zL3RoaXMuaW50ZXJuYWxTYW1wbGVSYXRlKjFlMyl9ZW9zKCl7dGhpcy5wcm9jZXNzQXVkaW8odGhpcy5zYW1wbGVSaW5nQnVmZmVyLDAsdGhpcy5mcmFtZVNhbXBsZVBvcywhMCl9cHJvY2Vzc0ZyYW1lKHQsZT0wLHM9LTEsaT0hMSl7dmFyIG87KG51bGw9PT0obz10aGlzLnZhZCl8fHZvaWQgMD09PW8/dm9pZCAwOm8udmFkT3B0aW9ucy5lbmFibGVkKSYmKHRoaXMudmFkLnByb2Nlc3NGcmFtZSh0LGUscyxpKSx0aGlzLnZhZC5pc1NpZ25hbERldGVjdGVkIT09dGhpcy53YXNTaWduYWxEZXRlY3RlZCYmdGhpcy5vblZhZFN0YXRlQ2hhbmdlKHRoaXMudmFkLmlzU2lnbmFsRGV0ZWN0ZWQpKX1wcm9jZXNzRW9zKCl7dmFyIHQ7dGhpcy5pc1NlbmRpbmcmJihudWxsPT09KHQ9dGhpcy52YWQpfHx2b2lkIDA9PT10P3ZvaWQgMDp0LnZhZE9wdGlvbnMuZW5hYmxlZCkmJih0aGlzLnZhZC5yZXNldFZBRCgpLHRoaXMub25WYWRTdGF0ZUNoYW5nZSghMSkpfX1jbGFzcyBpe2NvbnN0cnVjdG9yKHQsZSl7dGhpcy5pc1NpZ25hbERldGVjdGVkPSExLHRoaXMuc2lnbmFsRGI9LTkwLHRoaXMubm9pc2VMZXZlbERiPS05MCx0aGlzLmZyYW1lTWlsbGlzPTMwLHRoaXMuZW5lcmd5PTAsdGhpcy5iYXNlbGluZUVuZXJneT0tMSx0aGlzLmxvdWRGcmFtZUJpdHM9MCx0aGlzLnZhZFN1c3RhaW5NaWxsaXNMZWZ0PTAsdGhpcy5mcmFtZU1pbGxpcz10LHRoaXMudmFkT3B0aW9ucz1lfWFkanVzdFZhZE9wdGlvbnModCl7dGhpcy52YWRPcHRpb25zPU9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSx0aGlzLnZhZE9wdGlvbnMpLHQpfXJlc2V0VkFEKCl7dGhpcy5pc1NpZ25hbERldGVjdGVkPSExLHRoaXMubG91ZEZyYW1lQml0cz0wLHRoaXMuZW5lcmd5PTAsdGhpcy5iYXNlbGluZUVuZXJneT0tMX1wcm9jZXNzRnJhbWUodCxzPTAsaT0tMSxvPSExKXtpZighdGhpcy52YWRPcHRpb25zLmVuYWJsZWQpcmV0dXJuIHZvaWQgdGhpcy5yZXNldFZBRCgpO2lmKG8pcmV0dXJuO3RoaXMuZW5lcmd5PWUuZ2V0RW5lcmd5KHQscyxpKSx0aGlzLmJhc2VsaW5lRW5lcmd5PDAmJih0aGlzLmJhc2VsaW5lRW5lcmd5PXRoaXMuZW5lcmd5KTtjb25zdCBhPXRoaXMuZW5lcmd5Pk1hdGgubWF4KGUuZGJUb0VuZXJneSh0aGlzLnZhZE9wdGlvbnMubm9pc2VHYXRlRGIpLHRoaXMuYmFzZWxpbmVFbmVyZ3kqZS5kYlRvRW5lcmd5KHRoaXMudmFkT3B0aW9ucy5zaWduYWxUb05vaXNlRGIpKTt0aGlzLnB1c2hGcmFtZUhpc3RvcnkoYSksdGhpcy5pc1NpZ25hbERldGVjdGVkPXRoaXMuZGV0ZXJtaW5lTmV3U2lnbmFsU3RhdGUodGhpcy5pc1NpZ25hbERldGVjdGVkKSx0aGlzLmFkYXB0QmFja2dyb3VuZE5vaXNlKCksdGhpcy5zaWduYWxEYj1lLmVuZXJneVRvRGIodGhpcy5lbmVyZ3kvdGhpcy5iYXNlbGluZUVuZXJneSksdGhpcy5ub2lzZUxldmVsRGI9ZS5lbmVyZ3lUb0RiKHRoaXMuYmFzZWxpbmVFbmVyZ3kpfWRldGVybWluZU5ld1NpZ25hbFN0YXRlKHQpe3RoaXMudmFkU3VzdGFpbk1pbGxpc0xlZnQ9TWF0aC5tYXgodGhpcy52YWRTdXN0YWluTWlsbGlzTGVmdC10aGlzLmZyYW1lTWlsbGlzLDApO2NvbnN0IGU9dGhpcy5jb3VudExvdWRGcmFtZXModGhpcy52YWRPcHRpb25zLnNpZ25hbFNlYXJjaEZyYW1lcykscz1NYXRoLnJvdW5kKHRoaXMudmFkT3B0aW9ucy5zaWduYWxBY3RpdmF0aW9uKnRoaXMudmFkT3B0aW9ucy5zaWduYWxTZWFyY2hGcmFtZXMpLGk9TWF0aC5yb3VuZCh0aGlzLnZhZE9wdGlvbnMuc2lnbmFsUmVsZWFzZSp0aGlzLnZhZE9wdGlvbnMuc2lnbmFsU2VhcmNoRnJhbWVzKTtyZXR1cm4gZT49cz8odGhpcy52YWRTdXN0YWluTWlsbGlzTGVmdD10aGlzLnZhZE9wdGlvbnMuc2lnbmFsU3VzdGFpbk1pbGxpcywhMCk6IShlPD1pJiYwPT09dGhpcy52YWRTdXN0YWluTWlsbGlzTGVmdCkmJnR9YWRhcHRCYWNrZ3JvdW5kTm9pc2UoKXtpZighdGhpcy5pc1NpZ25hbERldGVjdGVkJiZ0aGlzLnZhZE9wdGlvbnMubm9pc2VMZWFybkhhbGZ0aW1lTWlsbGlzPjApe3ZhciB0PU1hdGgucG93KDIsLXRoaXMuZnJhbWVNaWxsaXMvdGhpcy52YWRPcHRpb25zLm5vaXNlTGVhcm5IYWxmdGltZU1pbGxpcyk7dGhpcy5iYXNlbGluZUVuZXJneT10aGlzLmJhc2VsaW5lRW5lcmd5KnQrdGhpcy5lbmVyZ3kqKDEtdCl9fXB1c2hGcmFtZUhpc3RvcnkodCl7dGhpcy5sb3VkRnJhbWVCaXRzPSh0PzE6MCl8dGhpcy5sb3VkRnJhbWVCaXRzPDwxfWNvdW50TG91ZEZyYW1lcyh0KXtsZXQgZT0wLHM9dGhpcy5sb3VkRnJhbWVCaXRzO2Zvcig7dD4wOykxPT0oMSZzKSYmZSsrLHM+Pj0xLHQtLTtyZXR1cm4gZX19dmFyIG8sYSxyOyFmdW5jdGlvbih0KXt0LlN0YXJ0ZWQ9InN0YXJ0ZWQiLHQuU3RvcHBlZD0ic3RvcHBlZCIsdC5TZWdtZW50RW5kPSJzZWdtZW50X2VuZCIsdC5UcmFuc2NyaXB0PSJ0cmFuc2NyaXB0Iix0LkVudGl0eT0iZW50aXR5Iix0LkludGVudD0iaW50ZW50Iix0LlRlbnRhdGl2ZVRyYW5zY3JpcHQ9InRlbnRhdGl2ZV90cmFuc2NyaXB0Iix0LlRlbnRhdGl2ZUVudGl0aWVzPSJ0ZW50YXRpdmVfZW50aXRpZXMiLHQuVGVudGF0aXZlSW50ZW50PSJ0ZW50YXRpdmVfaW50ZW50In0ob3x8KG89e30pKSxmdW5jdGlvbih0KXt0Lk9wZW5lZD0iV0VCU09DS0VUX09QRU4iLHQuQ2xvc2VkPSJXRUJTT0NLRVRfQ0xPU0VEIix0LkF1ZGlvUHJvY2Vzc29yUmVhZHk9IlNPVVJDRV9TQU1QTEVfUkFURV9TRVRfU1VDQ0VTUyIsdC5WYWRTaWduYWxIaWdoPSJWYWRTaWduYWxIaWdoIix0LlZhZFNpZ25hbExvdz0iVmFkU2lnbmFsTG93Iix0LlJlcXVlc3RDb250ZXh0U3RhcnQ9IlJlcXVlc3RDb250ZXh0U3RhcnQifShhfHwoYT17fSkpLGZ1bmN0aW9uKHQpe3QuY29ubmVjdD0iY29ubmVjdCIsdC5pbml0QXVkaW9Qcm9jZXNzb3I9ImluaXRBdWRpb1Byb2Nlc3NvciIsdC5hZGp1c3RBdWRpb1Byb2Nlc3Nvcj0iYWRqdXN0QXVkaW9Qcm9jZXNzb3IiLHQuU0VUX1NIQVJFRF9BUlJBWV9CVUZGRVJTPSJTRVRfU0hBUkVEX0FSUkFZX0JVRkZFUlMiLHQuQ0xPU0U9IkNMT1NFIix0LlNUQVJUX0NPTlRFWFQ9IlNUQVJUX0NPTlRFWFQiLHQuU1dJVENIX0NPTlRFWFQ9IlNXSVRDSF9DT05URVhUIix0LlNUT1BfQ09OVEVYVD0iU1RPUF9DT05URVhUIix0LkFVRElPPSJBVURJTyIsdC5zdGFydFN0cmVhbT0ic3RhcnRTdHJlYW0iLHQuc3RvcFN0cmVhbT0ic3RvcFN0cmVhbSIsdC5zZXRDb250ZXh0T3B0aW9ucz0ic2V0Q29udGV4dE9wdGlvbnMifShyfHwocj17fSkpO2NvbnN0IG49MCxoPTEsZD0yO2NsYXNzIGx7Y29uc3RydWN0b3IodCl7dGhpcy50YXJnZXRTYW1wbGVSYXRlPTE2ZTMsdGhpcy5pc0NvbnRleHRTdGFydGVkPSExLHRoaXMuYXVkaW9Db250ZXh0U3RhcnRUaW1lcz1bXSx0aGlzLmltbWVkaWF0ZU1vZGU9ITEsdGhpcy5mcmFtZU1pbGxpcz0zMCx0aGlzLm91dHB1dEF1ZGlvRnJhbWU9bmV3IEludDE2QXJyYXkodGhpcy5mcmFtZU1pbGxpcyp0aGlzLnRhcmdldFNhbXBsZVJhdGUvMWUzKSx0aGlzLmRlYnVnPSExLHRoaXMub25XZWJzb2NrZXRDbG9zZT10PT57dmFyIGU7aWYoIXRoaXMud2Vic29ja2V0KXRocm93IEVycm9yKCJXZWJTb2NrZXQgaXMgdW5kZWZpbmVkIik7bnVsbD09PShlPXRoaXMuYXVkaW9Qcm9jZXNzb3IpfHx2b2lkIDA9PT1lfHxlLnJlc2V0KCksdGhpcy5kZWJ1ZyYmY29uc29sZS5sb2coIltXZWJTb2NrZXRDbGllbnRdIiwib25XZWJzb2NrZXRDbG9zZSIpLHRoaXMud2Vic29ja2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm9wZW4iLHRoaXMub25XZWJzb2NrZXRPcGVuKSx0aGlzLndlYnNvY2tldC5yZW1vdmVFdmVudExpc3RlbmVyKCJtZXNzYWdlIix0aGlzLm9uV2Vic29ja2V0TWVzc2FnZSksdGhpcy53ZWJzb2NrZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZXJyb3IiLHRoaXMub25XZWJzb2NrZXRFcnJvciksdGhpcy53ZWJzb2NrZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiY2xvc2UiLHRoaXMub25XZWJzb2NrZXRDbG9zZSksdGhpcy53ZWJzb2NrZXQ9dm9pZCAwLHRoaXMud29ya2VyQ3R4LnBvc3RNZXNzYWdlKHt0eXBlOmEuQ2xvc2VkLGNvZGU6dC5jb2RlLHJlYXNvbjp0LnJlYXNvbix3YXNDbGVhbjp0Lndhc0NsZWFufSl9LHRoaXMub25XZWJzb2NrZXRPcGVuPXQ9Pnt0aGlzLmRlYnVnJiZjb25zb2xlLmxvZygiW1dlYlNvY2tldENsaWVudF0iLCJ3ZWJzb2NrZXQgb3BlbmVkIiksdGhpcy53b3JrZXJDdHgucG9zdE1lc3NhZ2Uoe3R5cGU6YS5PcGVuZWR9KX0sdGhpcy5vbldlYnNvY2tldEVycm9yPXQ9Pnt0aGlzLmRlYnVnJiZjb25zb2xlLmxvZygiW1dlYlNvY2tldENsaWVudF0iLCJ3ZWJzb2NrZXQgZXJyb3IiKX0sdGhpcy5vbldlYnNvY2tldE1lc3NhZ2U9dD0+e2xldCBlO3RyeXtlPUpTT04ucGFyc2UodC5kYXRhKX1jYXRjaCh0KXtyZXR1cm4gdm9pZCBjb25zb2xlLmVycm9yKCJbV2ViU29ja2V0Q2xpZW50XSIsImVycm9yIHBhcnNpbmcgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyOiIsdCl9aWYoZS50eXBlPT09by5TdGFydGVkKXtsZXQgdD10aGlzLmF1ZGlvQ29udGV4dFN0YXJ0VGltZXMuc2hpZnQoKTt2b2lkIDA9PT10JiYoY29uc29sZS53YXJuKCJObyB2YWxpZCB2YWx1ZSBmb3IgY29udGV4dFN0YXJ0TWlsbGlzIiksdD0wKTtjb25zdCBzPXthdWRpb1N0YXJ0VGltZU1pbGxpczp0fTtlLnBhcmFtcz1zfXRoaXMud29ya2VyQ3R4LnBvc3RNZXNzYWdlKGUpfSx0aGlzLndvcmtlckN0eD10fWNvbm5lY3QodCxlLHMsaSl7dGhpcy5kZWJ1Zz1pLHRoaXMuZGVidWcmJmNvbnNvbGUubG9nKCJbV2ViU29ja2V0Q2xpZW50XSIsImNvbm5lY3RpbmcgdG8gIix0KSx0aGlzLnRhcmdldFNhbXBsZVJhdGU9cyx0aGlzLmlzQ29udGV4dFN0YXJ0ZWQ9ITEsdGhpcy53ZWJzb2NrZXQ9bmV3IFdlYlNvY2tldCh0LGUpLHRoaXMud2Vic29ja2V0LmFkZEV2ZW50TGlzdGVuZXIoIm9wZW4iLHRoaXMub25XZWJzb2NrZXRPcGVuKSx0aGlzLndlYnNvY2tldC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIix0aGlzLm9uV2Vic29ja2V0TWVzc2FnZSksdGhpcy53ZWJzb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLHRoaXMub25XZWJzb2NrZXRFcnJvciksdGhpcy53ZWJzb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcigiY2xvc2UiLHRoaXMub25XZWJzb2NrZXRDbG9zZSl9aW5pdEF1ZGlvUHJvY2Vzc29yKHQsbyxyLG4pe3RoaXMuYXVkaW9Qcm9jZXNzb3I9bmV3IHModCx0aGlzLnRhcmdldFNhbXBsZVJhdGUsbyxyKSxuJiYodGhpcy5hdWRpb1Byb2Nlc3Nvci52YWQ9bmV3IGkobyxuKSx0aGlzLmF1ZGlvUHJvY2Vzc29yLm9uVmFkU3RhdGVDaGFuZ2U9dD0+e3ZhciBlLHM7Y29uc3QgaT1udWxsPT09KHM9bnVsbD09PShlPXRoaXMuYXVkaW9Qcm9jZXNzb3IpfHx2b2lkIDA9PT1lP3ZvaWQgMDplLnZhZCl8fHZvaWQgMD09PXM/dm9pZCAwOnMudmFkT3B0aW9ucztpJiYodCYmKHRoaXMuaW1tZWRpYXRlTW9kZT9pLmNvbnRyb2xMaXN0ZW5pbmcmJnRoaXMuc3RhcnRDb250ZXh0KHRoaXMuZGVmYXVsdENvbnRleHRPcHRpb25zKTp0aGlzLndvcmtlckN0eC5wb3N0TWVzc2FnZSh7dHlwZTphLlZhZFNpZ25hbEhpZ2h9KSksdHx8KHRoaXMuaW1tZWRpYXRlTW9kZT9pLmNvbnRyb2xMaXN0ZW5pbmcmJnRoaXMuc3RvcENvbnRleHQoKTp0aGlzLndvcmtlckN0eC5wb3N0TWVzc2FnZSh7dHlwZTphLlZhZFNpZ25hbExvd30pKSl9KSx0aGlzLmF1ZGlvUHJvY2Vzc29yLm9uU2VuZEF1ZGlvPSh0LHMsaSk9PntlLmNvbnZlcnRGbG9hdFRvSW50MTYodCx0aGlzLm91dHB1dEF1ZGlvRnJhbWUscyxpKSx0aGlzLnNlbmQodGhpcy5vdXRwdXRBdWRpb0ZyYW1lKX0sdm9pZCAwIT09dGhpcy53b3JrZXJDdHgmJnRoaXMud29ya2VyQ3R4LnBvc3RNZXNzYWdlKHt0eXBlOmEuQXVkaW9Qcm9jZXNzb3JSZWFkeX0pfWFkanVzdEF1ZGlvUHJvY2Vzc29yKHQpe2lmKHRoaXMuYXVkaW9Qcm9jZXNzb3ImJnQudmFkKXtpZighdGhpcy5hdWRpb1Byb2Nlc3Nvci52YWQpdGhyb3cgbmV3IEVycm9yKCJObyBWQUQgaW4gQXVkaW9Qcm9jZXNzb3IuIERpZCB5b3UgZGVmaW5lIGB2YWRgIGluIEJyb3dzZXJDbGllbnQgY29uc3RydWN0b3IgcGFyYW1ldGVycz8iKTt0aGlzLmF1ZGlvUHJvY2Vzc29yLnZhZC5hZGp1c3RWYWRPcHRpb25zKHQudmFkKX19c2V0U2hhcmVkQXJyYXlCdWZmZXJzKHQsZSl7dGhpcy5jb250cm9sU0FCPW5ldyBJbnQzMkFycmF5KHQpLHRoaXMuZGF0YVNBQj1uZXcgRmxvYXQzMkFycmF5KGUpO2NvbnN0IHM9dGhpcy5kYXRhU0FCLmxlbmd0aC8zMjt0aGlzLmRlYnVnJiZjb25zb2xlLmxvZygiW1dlYlNvY2tldENsaWVudF0iLCJBdWRpbyBoYW5kbGUgaW50ZXJ2YWwiLHMsIm1zIiksc2V0SW50ZXJ2YWwodGhpcy5wcm9jZXNzQXVkaW9TQUIuYmluZCh0aGlzKSxzKX1zdGFydFN0cmVhbSh0KXtpZighdGhpcy5hdWRpb1Byb2Nlc3Nvcil0aHJvdyBuZXcgRXJyb3IoIk5vIEF1ZGlvUHJvY2Vzc29yIik7dGhpcy5pbW1lZGlhdGVNb2RlPXQuaW1tZWRpYXRlLHRoaXMuYXVkaW9Qcm9jZXNzb3IucmVzZXQodC5zYW1wbGVSYXRlKSx0aGlzLmF1ZGlvQ29udGV4dFN0YXJ0VGltZXM9W119c3RvcFN0cmVhbSgpe2lmKCF0aGlzLmF1ZGlvUHJvY2Vzc29yKXRocm93IG5ldyBFcnJvcigiTm8gQXVkaW9Qcm9jZXNzb3IiKTt0aGlzLmF1ZGlvUHJvY2Vzc29yLmVvcygpfXByb2Nlc3NBdWRpbyh0KXtpZighdGhpcy5hdWRpb1Byb2Nlc3Nvcil0aHJvdyBuZXcgRXJyb3IoIk5vIEF1ZGlvUHJvY2Vzc29yIik7dGhpcy5hdWRpb1Byb2Nlc3Nvci5wcm9jZXNzQXVkaW8odCl9cHJvY2Vzc0F1ZGlvU0FCKCl7aWYoIXRoaXMuY29udHJvbFNBQnx8IXRoaXMuZGF0YVNBQil0aHJvdyBuZXcgRXJyb3IoIk5vIFNoYXJlZEFycmF5QnVmZmVycyIpO2NvbnN0IHQ9dGhpcy5jb250cm9sU0FCW2hdO2lmKDA9PT10aGlzLmNvbnRyb2xTQUJbZF0mJnQ+MCl7Y29uc3QgZT10aGlzLmRhdGFTQUIuc3ViYXJyYXkoMCx0KTt0aGlzLmNvbnRyb2xTQUJbaF09MCx0aGlzLmNvbnRyb2xTQUJbbl09MCxlLmxlbmd0aD4wJiZ0aGlzLnByb2Nlc3NBdWRpbyhlKX19c3RhcnRDb250ZXh0KHQpe3ZhciBlO2lmKCF0aGlzLmF1ZGlvUHJvY2Vzc29yKXRocm93IEVycm9yKCJObyBBdWRpb1Byb2Nlc3NvciIpO2lmKHRoaXMuaXNDb250ZXh0U3RhcnRlZClyZXR1cm4gdm9pZCBjb25zb2xlLmVycm9yKCJbV2ViU29ja2V0Q2xpZW50XSIsImNhbid0IHN0YXJ0IGNvbnRleHQ6IGFjdGl2ZSBjb250ZXh0IGV4aXN0cyIpO3RoaXMuYXVkaW9Qcm9jZXNzb3Iuc2V0U2VuZEF1ZGlvKCEwKSx0aGlzLmlzQ29udGV4dFN0YXJ0ZWQ9ITAsdGhpcy5hdWRpb0NvbnRleHRTdGFydFRpbWVzLnB1c2godGhpcy5hdWRpb1Byb2Nlc3Nvci5nZXRTdHJlYW1Qb3NpdGlvbigpKSx0aGlzLndvcmtlckN0eC5wb3N0TWVzc2FnZSh7dHlwZTphLlJlcXVlc3RDb250ZXh0U3RhcnR9KTtsZXQgcz1udWxsIT09KGU9dGhpcy5kZWZhdWx0Q29udGV4dE9wdGlvbnMpJiZ2b2lkIDAhPT1lP2U6e307dm9pZCAwIT09dCYmKHM9T2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LHMpLHQpKTtjb25zdCBpPXUocyk7aS5ldmVudD0ic3RhcnQiLHRoaXMuc2VuZChKU09OLnN0cmluZ2lmeShpKSl9c3RvcENvbnRleHQoKXtpZighdGhpcy5hdWRpb1Byb2Nlc3Nvcil0aHJvdyBFcnJvcigiTm8gQXVkaW9Qcm9jZXNzb3IiKTtpZih0aGlzLmlzQ29udGV4dFN0YXJ0ZWQpe2lmKHRoaXMuYXVkaW9Qcm9jZXNzb3Iuc2V0U2VuZEF1ZGlvKCExKSx0aGlzLmlzQ29udGV4dFN0YXJ0ZWQ9ITEsdGhpcy53ZWJzb2NrZXQpe2NvbnN0IHQ9SlNPTi5zdHJpbmdpZnkoe2V2ZW50OiJzdG9wIn0pO3RoaXMuc2VuZCh0KX19ZWxzZSBjb25zb2xlLmVycm9yKCJbV2ViU29ja2V0Q2xpZW50XSIsImNhbid0IHN0b3AgY29udGV4dDogbm8gYWN0aXZlIGNvbnRleHQiKX1zd2l0Y2hDb250ZXh0KHQpe2lmKCF0aGlzLndlYnNvY2tldCl0aHJvdyBFcnJvcigiV2ViU29ja2V0IGlzIHVuZGVmaW5lZCIpO2lmKCF0aGlzLmlzQ29udGV4dFN0YXJ0ZWQpcmV0dXJuIHZvaWQgY29uc29sZS5lcnJvcigiW1dlYlNvY2tldENsaWVudF0iLCJjYW4ndCBzd2l0Y2ggY29udGV4dDogbm8gYWN0aXZlIGNvbnRleHQiKTtpZih2b2lkIDA9PT0obnVsbD09dD92b2lkIDA6dC5hcHBJZCkpcmV0dXJuIHZvaWQgY29uc29sZS5lcnJvcigiW1dlYlNvY2tldENsaWVudF0iLCJjYW4ndCBzd2l0Y2ggY29udGV4dDogbmV3IGFwcCBpZCBpcyB1bmRlZmluZWQiKTtjb25zdCBlPUpTT04uc3RyaW5naWZ5KHtldmVudDoic3RvcCJ9KTt0aGlzLnNlbmQoZSk7Y29uc3Qgcz11KHQpO3MuZXZlbnQ9InN0YXJ0Iix0aGlzLnNlbmQoSlNPTi5zdHJpbmdpZnkocykpfWNsb3NlV2Vic29ja2V0KHQ9MTAwNSxlPSJObyBTdGF0dXMgUmVjZWl2ZWQiKXtpZih0aGlzLmRlYnVnJiZjb25zb2xlLmxvZygiW1dlYlNvY2tldENsaWVudF0iLCJXZWJzb2NrZXQgY2xvc2luZyIpLCF0aGlzLndlYnNvY2tldCl0aHJvdyBFcnJvcigiV2ViU29ja2V0IGlzIHVuZGVmaW5lZCIpO3RoaXMud2Vic29ja2V0LmNsb3NlKHQsZSl9c2VuZCh0KXtpZighdGhpcy53ZWJzb2NrZXQpdGhyb3cgbmV3IEVycm9yKCJObyBXZWJzb2NrZXQiKTtpZih0aGlzLndlYnNvY2tldC5yZWFkeVN0YXRlIT09dGhpcy53ZWJzb2NrZXQuT1BFTil0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIE9QRU4gV2Vic29ja2V0IHN0YXRlLCBidXQgZ290ICR7dGhpcy53ZWJzb2NrZXQucmVhZHlTdGF0ZX1gKTt0cnl7dGhpcy53ZWJzb2NrZXQuc2VuZCh0KX1jYXRjaCh0KXtjb25zb2xlLmxvZygiW1dlYlNvY2tldENsaWVudF0iLCJzZXJ2ZXIgY29ubmVjdGlvbiBlcnJvciIsdCl9fXNldENvbnRleHRPcHRpb25zKHQpe3RoaXMuZGVmYXVsdENvbnRleHRPcHRpb25zPXR9fWNvbnN0IGM9c2VsZixtPW5ldyBsKGMpO2Z1bmN0aW9uIHUodCl7Y29uc3QgZT17b3B0aW9uczp7dGltZXpvbmU6W0ludGwuRGF0ZVRpbWVGb3JtYXQoKS5yZXNvbHZlZE9wdGlvbnMoKS50aW1lWm9uZV19fTtyZXR1cm4gdm9pZCAwPT09dHx8KGUub3B0aW9ucy52b2NhYnVsYXJ5PXQudm9jYWJ1bGFyeSxlLm9wdGlvbnMudm9jYWJ1bGFyeV9iaWFzPXQudm9jYWJ1bGFyeUJpYXMsZS5vcHRpb25zLnNpbGVuY2VfdHJpZ2dlcmVkX3NlZ21lbnRhdGlvbj10LnNpbGVuY2VUcmlnZ2VyZWRTZWdtZW50YXRpb24sdC5ub25TdHJlYW1pbmdObHU/ZS5vcHRpb25zLm5vbl9zdHJlYW1pbmdfbmx1PVsieWVzIl06ZS5vcHRpb25zLm5vbl9zdHJlYW1pbmdfbmx1PVsibm8iXSx2b2lkIDAhPT0obnVsbD09dD92b2lkIDA6dC50aW1lem9uZSkmJihlLm9wdGlvbnMudGltZXpvbmU9bnVsbD09dD92b2lkIDA6dC50aW1lem9uZSksdm9pZCAwIT09dC5hcHBJZCYmKGUuYXBwSWQ9dC5hcHBJZCkpLGV9cmV0dXJuIGMub25tZXNzYWdlPWZ1bmN0aW9uKHQpe3N3aXRjaCh0LmRhdGEudHlwZSl7Y2FzZSByLmNvbm5lY3Q6bS5jb25uZWN0KHQuZGF0YS5hcGlVcmwsdC5kYXRhLmF1dGhUb2tlbix0LmRhdGEudGFyZ2V0U2FtcGxlUmF0ZSx0LmRhdGEuZGVidWcpO2JyZWFrO2Nhc2Ugci5pbml0QXVkaW9Qcm9jZXNzb3I6bS5pbml0QXVkaW9Qcm9jZXNzb3IodC5kYXRhLnNvdXJjZVNhbXBsZVJhdGUsdC5kYXRhLmZyYW1lTWlsbGlzLHQuZGF0YS5oaXN0b3J5RnJhbWVzLHQuZGF0YS52YWRPcHRpb25zKTticmVhaztjYXNlIHIuYWRqdXN0QXVkaW9Qcm9jZXNzb3I6bS5hZGp1c3RBdWRpb1Byb2Nlc3Nvcih0LmRhdGEucGFyYW1zKTticmVhaztjYXNlIHIuU0VUX1NIQVJFRF9BUlJBWV9CVUZGRVJTOm0uc2V0U2hhcmVkQXJyYXlCdWZmZXJzKHQuZGF0YS5jb250cm9sU0FCLHQuZGF0YS5kYXRhU0FCKTticmVhaztjYXNlIHIuQ0xPU0U6bS5jbG9zZVdlYnNvY2tldCgxZTMsIkNsb3NlIHJlcXVlc3RlZCBieSBjbGllbnQiKTticmVhaztjYXNlIHIuc3RhcnRTdHJlYW06bS5zdGFydFN0cmVhbSh0LmRhdGEuc3RyZWFtT3B0aW9ucyk7YnJlYWs7Y2FzZSByLnN0b3BTdHJlYW06bS5zdG9wU3RyZWFtKCk7YnJlYWs7Y2FzZSByLlNUQVJUX0NPTlRFWFQ6bS5zdGFydENvbnRleHQodC5kYXRhLm9wdGlvbnMpO2JyZWFrO2Nhc2Ugci5TV0lUQ0hfQ09OVEVYVDptLnN3aXRjaENvbnRleHQodC5kYXRhLm9wdGlvbnMpO2JyZWFrO2Nhc2Ugci5TVE9QX0NPTlRFWFQ6bS5zdG9wQ29udGV4dCgpO2JyZWFrO2Nhc2Ugci5BVURJTzptLnByb2Nlc3NBdWRpbyh0LmRhdGEucGF5bG9hZCk7YnJlYWs7Y2FzZSByLnNldENvbnRleHRPcHRpb25zOm0uc2V0Q29udGV4dE9wdGlvbnModC5kYXRhLm9wdGlvbnMpO2JyZWFrO2RlZmF1bHQ6Y29uc29sZS5sb2coIldPUktFUiIsdCl9fSx0LmNvbnRleHRPcHRpb25zVG9Nc2c9dSx0LmRlZmF1bHQ9bCxPYmplY3QuZGVmaW5lUHJvcGVydHkodCwiX19lc01vZHVsZSIse3ZhbHVlOiEwfSksdH0oe30pOwoK",this.worker.addEventListener("message",this.onWebsocketMessage)}onResponse(t){this.onResponseCb=t}onClose(t){this.onCloseCb=t}initialize(e,i,s,n){return o(this,void 0,void 0,(function*(){return this.worker.postMessage({type:t.ControllerSignal.connect,apiUrl:e,authToken:i,targetSampleRate:s,debug:n}),this.startCbs=[],this.stopCbs=[],new Promise((t=>{this.resolveInitialization=t}))}))}initAudioProcessor(e,i,s,n){return o(this,void 0,void 0,(function*(){return this.worker.postMessage({type:t.ControllerSignal.initAudioProcessor,sourceSampleRate:e,frameMillis:i,historyFrames:s,vadOptions:n}),new Promise((t=>{this.resolveSourceSampleRateSet=t}))}))}adjustAudioProcessor(e){this.worker.postMessage({type:t.ControllerSignal.adjustAudioProcessor,params:e})}close(){return o(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{this.worker.postMessage({type:t.ControllerSignal.CLOSE,code:1e3,message:"Client has ended the session"}),e()}))}))}startStream(e){return o(this,void 0,void 0,(function*(){this.worker.postMessage({type:t.ControllerSignal.startStream,streamOptions:e})}))}stopStream(){return o(this,void 0,void 0,(function*(){this.worker.postMessage({type:t.ControllerSignal.stopStream})}))}startContext(e){return o(this,void 0,void 0,(function*(){return new Promise(((i,s)=>{this.startCbs.push(((t,e)=>{void 0!==t?s(t):i(e)})),this.worker.postMessage({type:t.ControllerSignal.START_CONTEXT,options:e})}))}))}stopContext(){return o(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{this.stopCbs.push(((t,s)=>{void 0!==t?i(t):e(s)})),this.worker.postMessage({type:t.ControllerSignal.STOP_CONTEXT})}))}))}switchContext(e){return o(this,void 0,void 0,(function*(){return new Promise(((i,s)=>{this.startCbs.push(((t,e)=>{void 0!==t?s(t):i(e)})),this.worker.postMessage({type:t.ControllerSignal.SWITCH_CONTEXT,options:e})}))}))}postMessage(t){this.worker.postMessage(t)}sendAudio(e){this.worker.postMessage({type:t.ControllerSignal.AUDIO,payload:e})}setContextOptions(e){return o(this,void 0,void 0,(function*(){this.worker.postMessage({type:t.ControllerSignal.setContextOptions,options:e})}))}}class J{constructor(){this.storage=window.localStorage}get(t){return this.storage.getItem(t)}set(t,e){this.storage.setItem(t,e)}getOrSet(t,e){let i=this.storage.getItem(t);return null===i&&(i=e(),this.storage.setItem(t,i)),i}}function k(t,e){return{intent:t.intent,isFinal:e}}const M="speechly-auth-token";class E{constructor(e){var i,s;if(this.streamOptions=y,this.activeContexts=0,this.audioContexts=new Map,this.maxReconnectAttemptCount=10,this.connectAttempt=0,this.connectPromise=null,this.cbs=[],this.state=t.DecoderState.Disconnected,this.handleWebsocketResponse=e=>{var i;switch(this.debug&&console.log("[Decoder]","Received response",e),e.type){case t.WorkerSignal.VadSignalHigh:this.cbs.forEach((t=>t.onVadStateChange.forEach((t=>t(!0)))));break;case t.WorkerSignal.VadSignalLow:this.cbs.forEach((t=>t.onVadStateChange.forEach((t=>t(!1)))));break;case t.WorkerSignal.RequestContextStart:this.activeContexts++;break;case t.WebsocketResponseType.Started:{const t=e.params;this.audioContexts.set(e.audio_context,{segments:new Map,audioStartTimeMillis:null!==(i=null==t?void 0:t.audioStartTimeMillis)&&void 0!==i?i:0}),this.cbs.forEach((t=>t.contextStartedCbs.forEach((t=>t(e.audio_context)))));break}case t.WebsocketResponseType.Stopped:this.activeContexts--,this.cbs.forEach((t=>t.contextStoppedCbs.forEach((t=>t(e.audio_context))))),this.streamOptions.preserveSegments||this.audioContexts.delete(e.audio_context),void 0!==this.resolveStopStream&&0===this.activeContexts&&this.resolveStopStream();break;default:this.handleSegmentUpdate(e)}},this.handleSegmentUpdate=e=>{var i;const{audio_context:s,segment_id:o,type:a}=e;let{data:d}=e;const c=this.audioContexts.get(s);if(void 0===c)return void console.warn("[Decoder]","Received response for non-existent context",s);let l=null!==(i=c.segments.get(o))&&void 0!==i?i:new n(s,o);switch(a){case t.WebsocketResponseType.TentativeTranscript:const e=function(t,e){return t.words.map((({word:t,index:i,start_timestamp:s,end_timestamp:n})=>({value:t,index:i,startTimestamp:s+e,endTimestamp:n+e,isFinal:!1})))}(d,c.audioStartTimeMillis),i=d.transcript;this.cbs.forEach((t=>t.tentativeTranscriptCbs.forEach((t=>t(s,o,e,i))))),l=l.updateTranscript(e);break;case t.WebsocketResponseType.Transcript:const n=function(t,e){return{value:t.word,index:t.index,startTimestamp:t.start_timestamp+e,endTimestamp:t.end_timestamp+e,isFinal:!0}}(d,c.audioStartTimeMillis);this.cbs.forEach((t=>t.transcriptCbs.forEach((t=>t(s,o,n))))),l=l.updateTranscript([n]);break;case t.WebsocketResponseType.TentativeEntities:const a=function(t){return t.entities.map((({entity:t,value:e,start_position:i,end_position:s})=>({type:t,value:e,startPosition:i,endPosition:s,isFinal:!1})))}(d);this.cbs.forEach((t=>t.tentativeEntityCbs.forEach((t=>t(s,o,a))))),l=l.updateEntities(a);break;case t.WebsocketResponseType.Entity:const r=function(t){return{type:t.entity,value:t.value,startPosition:t.start_position,endPosition:t.end_position,isFinal:!0}}(d);this.cbs.forEach((t=>t.entityCbs.forEach((t=>t(s,o,r))))),l=l.updateEntities([r]);break;case t.WebsocketResponseType.TentativeIntent:const h=k(d,!1);this.cbs.forEach((t=>t.tentativeIntentCbs.forEach((t=>t(s,o,h))))),l=l.updateIntent(h);break;case t.WebsocketResponseType.Intent:const p=k(d,!0);this.cbs.forEach((t=>t.intentCbs.forEach((t=>t(s,o,p))))),l=l.updateIntent(p);break;case t.WebsocketResponseType.SegmentEnd:l=l.finalize()}c.segments.set(o,l),this.audioContexts.set(s,c),this.logSegments&&console.info(l.toString()),this.cbs.forEach((t=>t.segmentChangeCbs.forEach((t=>t(l.toSegment())))))},this.handleWebsocketClosure=e=>{if(1e3===e.code)this.debug&&console.log("[Decoder]","Websocket closed",e);else{if(console.error("[Decoder]","Websocket closed due to error",e),void 0===this.deviceId)return this.setState(t.DecoderState.Failed),void console.error("[Decoder]","No deviceId. Giving up reconnecting.");this.setState(t.DecoderState.Disconnected),this.activeContexts=0,this.audioContexts.clear(),this.reconnect()}},this.logSegments=e.logSegments,this.appId=e.appId,this.projectId=e.projectId,this.sampleRate=e.sampleRate,this.debug=e.debug,void 0!==this.appId&&void 0!==this.projectId)throw Error("[Decoder] You cannot use both appId and projectId at the same time");if(void 0===this.appId&&void 0===this.projectId)throw Error("[Decoder] Either an appId or a projectId is required");const o=e.apiUrl;this.apiUrl=function(t,e){const i=new URLSearchParams;return i.append("sampleRate",e.toString()),`${t}?${i.toString()}`}(o.replace("http","ws")+"/ws/v1",this.sampleRate),this.loginUrl=`${o}/login`,this.storage=null!==(i=e.storage)&&void 0!==i?i:new J,this.deviceId=this.storage.getOrSet("speechly-device-id",L),this.apiClient=new I,this.apiClient.onResponse(this.handleWebsocketResponse),this.apiClient.onClose(this.handleWebsocketClosure),(null===(s=e.connect)||void 0===s||s)&&this.connect()}getReconnectDelayMs(t){return 100*Math.pow(2,t)}sleep(t){return o(this,void 0,void 0,(function*(){return new Promise((e=>setTimeout(e,t)))}))}connect(){return o(this,void 0,void 0,(function*(){null===this.connectPromise&&(this.connectPromise=(()=>o(this,void 0,void 0,(function*(){const e=this.storage.get(M);if(null!=e&&w(e,this.projectId,this.appId,this.deviceId))this.authToken=e;else try{this.authToken=yield function(t,e,i,s,n=fetch,a=Date.now){var d;return o(this,void 0,void 0,(function*(){let o;o=void 0!==e?{projectId:e,deviceId:s}:{appId:i,deviceId:s};const c=yield n(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),l=yield c.json();if(200!==c.status)throw Error(null!==(d=l.error)&&void 0!==d?d:`Speechly API login request failed with ${c.status}`);if(void 0===l.access_token)throw Error("Invalid login response from Speechly API");if(!w(l.access_token,e,i,s,a))throw Error("Invalid token received from Speechly API");return l.access_token}))}(this.loginUrl,this.projectId,this.appId,this.deviceId,fetch),this.storage.set(M,this.authToken)}catch(e){throw this.setState(t.DecoderState.Failed),e}yield this.apiClient.initialize(this.apiUrl,this.authToken,this.sampleRate,this.debug),this.advanceState(t.DecoderState.Connected)})))()),yield this.connectPromise}))}adjustAudioProcessor(t){this.apiClient.adjustAudioProcessor(t)}close(){return o(this,void 0,void 0,(function*(){let e;try{yield this.apiClient.close()}catch(t){e=t.message}if(this.audioContexts.clear(),this.activeContexts=0,this.connectPromise=null,this.setState(t.DecoderState.Disconnected),void 0!==e)throw Error(e)}))}startStream(t){return o(this,void 0,void 0,(function*(){this.debug&&console.log("[Decoder]","startStream"),this.streamOptions=t,this.audioContexts.clear(),this.activeContexts=0,yield this.apiClient.startStream(t)}))}stopStream(){return o(this,void 0,void 0,(function*(){this.debug&&console.log("[Decoder]","stopStream"),yield this.apiClient.stopStream(),yield this.waitResults()}))}waitResults(){return o(this,void 0,void 0,(function*(){if(this.activeContexts>0){const t=new Promise((t=>{this.resolveStopStream=t}));yield t}this.resolveStopStream=void 0}))}startContext(e){return o(this,void 0,void 0,(function*(){if(this.state===t.DecoderState.Failed)throw Error("[Decoder] startContext cannot be run in Failed state.");if(this.state<t.DecoderState.Connected)yield this.connect();else if(this.state>t.DecoderState.Connected)throw Error("[Decoder] Unable to complete startContext: Expected Connected state, but was in "+S(this.state)+".");let s;if(this.setState(t.DecoderState.Active),null!=this.projectId){if(!(null==e?void 0:e.appId))throw new Error("options.appId is required with project login");s=yield this.apiClient.startContext(e)}else{if(null!=(null==e?void 0:e.appId)&&this.appId!==(null==e?void 0:e.appId))throw this.setState(t.DecoderState.Failed),i;s=yield this.apiClient.startContext(e)}if(this.state<t.DecoderState.Active)throw Error("[Decoder] Unable to complete startContext: Problem acquiring contextId");return s}))}sendAudio(t){this.apiClient.sendAudio(t)}stopContext(e){return o(this,void 0,void 0,(function*(){if(this.state===t.DecoderState.Failed)throw Error("[Decoder] stopContext cannot be run in unrecovable error state.");if(this.state!==t.DecoderState.Active)throw Error("[Decoder] Unable to complete stopContext: Expected Active state, but was in "+S(this.state)+".");e>0&&(yield this.sleep(e));const i=yield this.apiClient.stopContext();return this.setState(t.DecoderState.Connected),i}))}switchContext(e){return o(this,void 0,void 0,(function*(){if(this.state!==t.DecoderState.Active)throw Error("[Decoder] Unable to complete switchContext: Expected Active state, but was in "+S(this.state)+".");return yield this.apiClient.switchContext(e)}))}registerListener(t){this.cbs.push(t)}initAudioProcessor(t,e,i,s){return o(this,void 0,void 0,(function*(){yield this.apiClient.initAudioProcessor(t,e,i,s)}))}useSharedArrayBuffers(t,e){this.apiClient.postMessage({type:"SET_SHARED_ARRAY_BUFFERS",controlSAB:t,dataSAB:e})}setContextOptions(t){return o(this,void 0,void 0,(function*(){yield this.apiClient.setContextOptions(t)}))}reconnect(){return o(this,void 0,void 0,(function*(){this.debug&&console.log("[Decoder]","Reconnecting...",this.connectAttempt),this.connectPromise=null,this.connectAttempt<this.maxReconnectAttemptCount?(yield this.sleep(this.getReconnectDelayMs(this.connectAttempt++)),yield this.connect()):console.error("[Decoder] Maximum reconnect count reached, giving up automatic reconnect.")}))}advanceState(t){this.state>=t||this.setState(t)}setState(t){this.state!==t&&(this.debug&&console.log("[Decoder]",S(this.state),"->",S(t)),this.state=t,this.cbs.forEach((e=>{var i;return null===(i=e.stateChangeCbs)||void 0===i?void 0:i.forEach((e=>e(t)))})))}getSegments(){const t=[];return this.audioContexts.forEach(((e,i)=>{e.segments.forEach(((e,i)=>{const s=JSON.parse(JSON.stringify(e));t.push(s)}))})),t}}t.BrowserClient=class{constructor(t){var e,i;this.contextStopDelay=250,this.debug=!1,this.initialized=!1,this.audioProcessorInitialized=!1,this.isStreaming=!1,this.active=!1,this.listeningPromise=null,this.streamOptions=Object.assign({},y),this.stats={maxSignalEnergy:0,sentSamples:0},this.decoderOptions=Object.assign(Object.assign(Object.assign({},m),t),{vad:t.vad?Object.assign(Object.assign({},Z),t.vad):void 0});const s=window.navigator.mediaDevices.getSupportedConstraints();this.nativeResamplingSupported=!0===s.sampleRate,this.isMobileSafari=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].indexOf(navigator.platform)>=0||navigator.userAgent.includes("Mac")&&"ontouchend"in document,this.isSafari=this.isMobileSafari||void 0!==window.safari,this.useSAB=!this.isSafari,this.debug=null===(e=this.decoderOptions.debug)||void 0===e||e,this.callbacks=new W,this.callbacks.stateChangeCbs.addEventListener(this.handleStateChange.bind(this)),this.callbacks.onVadStateChange.addEventListener(this.autoControlListening.bind(this)),this.decoder=null!==(i=this.decoderOptions.decoder)&&void 0!==i?i:new E(this.decoderOptions),this.decoder.registerListener(this.callbacks)}initialize(t){var i,n;return o(this,void 0,void 0,(function*(){if(!this.initialized){this.initialized=!0,this.debug&&console.log("[BrowserClient]","initializing"),yield this.decoder.connect();try{const t={};if(this.nativeResamplingSupported&&(t.sampleRate=s),void 0!==window.webkitAudioContext)try{this.audioContext=new window.webkitAudioContext(t)}catch(t){this.debug&&console.log("[BrowserClient]","creating audioContext without samplerate conversion",t),this.audioContext=new window.webkitAudioContext}else this.audioContext=new window.AudioContext(t),void 0!==window.webkitAudioContext&&(yield this.audioContext.resume())}catch(t){throw e}if(this.isSafari||void 0===window.AudioWorkletNode){if(this.debug&&console.log("[BrowserClient]","using ScriptProcessorNode"),void 0!==window.webkitAudioContext){const t=this.audioContext.sampleRate/s,e=4096*Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)));this.audioProcessor=this.audioContext.createScriptProcessor(e,1,1)}else this.audioProcessor=this.audioContext.createScriptProcessor(void 0,1,1);this.audioProcessor.connect(this.audioContext.destination),this.audioProcessor.addEventListener("audioprocess",(t=>{this.handleAudio(t.inputBuffer.getChannelData(0))}))}else{this.debug&&console.log("[BrowserClient]","using AudioWorkletNode");const t=new Blob(["\n// Indices for the Control SAB.\nconst CONTROL = {\n  'WRITE_INDEX': 0,\n  'FRAMES_AVAILABLE': 1,\n  'LOCK': 2,\n};\n\nclass SpeechlyProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n\n    this._initialized = false;\n    this.debug = false;\n    this.port.onmessage = this._initialize.bind(this);\n  }\n\n  _initialize(event) {\n    this.controlSAB = new Int32Array(event.data.controlSAB);\n    this.dataSAB = new Float32Array(event.data.dataSAB);\n    this.debug = event.data.debug;\n    if (this.debug) {\n      console.log('[BrowserClient AudioWorkletNode]', 'initializing audioworklet');\n    }\n    this.sharedBufferSize = this.dataSAB.length;\n    this.buffer = new Float32Array(0);\n    this._initialized = true;\n  }\n\n  _transferDataToSharedBuffer(data) {\n    this.controlSAB[CONTROL.LOCK] = 1;\n    let inputWriteIndex = this.controlSAB[CONTROL.WRITE_INDEX];\n    if (this.controlSAB[CONTROL.FRAMES_AVAILABLE] > 0) {\n      if (inputWriteIndex + data.length > this.sharedBufferSize) {\n        // console.log('buffer overflow')\n        inputWriteIndex = 0;\n      }\n    }\n    this.dataSAB.set(data, inputWriteIndex);\n    this.controlSAB[CONTROL.WRITE_INDEX] = inputWriteIndex + data.length;\n    this.controlSAB[CONTROL.FRAMES_AVAILABLE] = inputWriteIndex + data.length;\n    this.controlSAB[CONTROL.LOCK] = 0;\n  }\n\n  _pushData(data) {\n    if (this.debug) {\n      const signalEnergy = getStandardDeviation(data)\n      this.port.postMessage({\n        type: 'STATS',\n        signalEnergy: signalEnergy,\n        samples: data.length,\n      });\n    }\n\n    if (this.buffer.length > this.sharedBufferSize) {\n      const dataToTransfer = this.buffer.subarray(0, this.sharedBufferSize);\n      this._transferDataToSharedBuffer(dataToTransfer);\n      this.buffer = this.buffer.subarray(this.sharedBufferSize);\n    }\n    let concat = new Float32Array(this.buffer.length + data.length);\n    concat.set(this.buffer);\n    concat.set(data, this.buffer.length);\n    this.buffer = concat;\n  }\n\n  process(inputs, outputs, parameters) {\n    const inputChannelData = inputs[0][0];\n    if (inputChannelData !== undefined) {\n      if (this.controlSAB && this.dataSAB) {\n        this._pushData(inputChannelData);\n      } else {\n        this.port.postMessage({\n          type: 'DATA',\n          frames: inputChannelData\n        });\n      }\n    }\n\n    return true;\n  }\n}\n\nfunction getStandardDeviation(array) {\n  const n = array.length\n  const mean = array.reduce((a, b) => a + b) / n\n  return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)\n}\n\nregisterProcessor('speechly-worklet', SpeechlyProcessor);\n"],{type:"text/javascript"}),e=window.URL.createObjectURL(t);if(yield this.audioContext.audioWorklet.addModule(e),this.speechlyNode=new AudioWorkletNode(this.audioContext,"speechly-worklet"),this.speechlyNode.connect(this.audioContext.destination),this.useSAB&&void 0!==window.SharedArrayBuffer){this.debug&&console.log("[BrowserClient]","using SharedArrayBuffer");const t=new window.SharedArrayBuffer(4*Int32Array.BYTES_PER_ELEMENT),e=new window.SharedArrayBuffer(1024*Float32Array.BYTES_PER_ELEMENT);this.decoder.useSharedArrayBuffers(t,e),this.speechlyNode.port.postMessage({type:"SET_SHARED_ARRAY_BUFFERS",controlSAB:t,dataSAB:e,debug:this.debug})}else this.debug&&console.log("[BrowserClient]","can not use SharedArrayBuffer");this.speechlyNode.port.onmessage=t=>{switch(t.data.type){case"STATS":t.data.signalEnergy>this.stats.maxSignalEnergy&&(this.stats.maxSignalEnergy=t.data.signalEnergy),this.stats.sentSamples+=parseInt(t.data.samples);break;case"DATA":this.handleAudio(t.data.frames)}}}this.debug&&console.log("[BrowserClient]","audioContext sampleRate is",null===(i=this.audioContext)||void 0===i?void 0:i.sampleRate),this.streamOptions.sampleRate=null===(n=this.audioContext)||void 0===n?void 0:n.sampleRate,yield this.decoder.initAudioProcessor(this.streamOptions.sampleRate,this.decoderOptions.frameMillis,this.decoderOptions.historyFrames,this.decoderOptions.vad),this.audioProcessorInitialized=!0,(null==t?void 0:t.mediaStream)&&(yield this.attach(null==t?void 0:t.mediaStream))}}))}attach(t){var e,i,s,n,a,d;return o(this,void 0,void 0,(function*(){if(yield this.initialize(),yield this.detach(),this.stream=null===(e=this.audioContext)||void 0===e?void 0:e.createMediaStreamSource(t),"running"!==(null===(i=this.audioContext)||void 0===i?void 0:i.state)&&(this.debug&&console.log("[BrowserClient]","audioContext resume required, state is",null===(s=this.audioContext)||void 0===s?void 0:s.state),yield null===(n=this.audioContext)||void 0===n?void 0:n.resume()),this.speechlyNode)null===(a=this.stream)||void 0===a||a.connect(this.speechlyNode);else{if(!this.audioProcessor)throw Error("[BrowserClient] cannot attach to mediaStream, not initialized");null===(d=this.stream)||void 0===d||d.connect(this.audioProcessor)}yield this.autoControlStream()}))}isActive(){return this.active}start(t){return o(this,void 0,void 0,(function*(){if(this.active)throw X;this.active=!0;return yield this.queueTask((()=>o(this,void 0,void 0,(function*(){yield this.initialize(),this.isStreaming||(yield this.startStream({autoStarted:!0}));return yield this.decoder.startContext(t)}))))}))}stop(t=this.contextStopDelay){return o(this,void 0,void 0,(function*(){if(!this.active)throw R;this.active=!1;return yield this.queueTask((()=>o(this,void 0,void 0,(function*(){var e;try{const i=yield this.decoder.stopContext(t);return!(null===(e=this.decoderOptions.vad)||void 0===e?void 0:e.enabled)&&this.isStreaming&&this.streamOptions.autoStarted&&(yield this.stopStream()),0===this.stats.sentSamples&&console.warn("[BrowserClient]","audioContext contained no audio data"),i}catch(t){console.warn("[BrowserClient]","stop() failed",t)}finally{this.stats.sentSamples=0}}))))}))}setContextOptions(t){return o(this,void 0,void 0,(function*(){yield this.decoder.setContextOptions(t)}))}adjustAudioProcessor(t){var e;if(t.vad){if(!this.decoderOptions.vad)throw Error("Unable to adjust VAD - it was not defined in the constructor");this.decoderOptions.vad=Object.assign(Object.assign({},this.decoderOptions.vad),t.vad)}this.decoder.adjustAudioProcessor(t),(null===(e=this.decoderOptions.vad)||void 0===e?void 0:e.enabled)?this.autoControlStream():this.active&&this.stop()}uploadAudioData(t,e){var i,s,n;return o(this,void 0,void 0,(function*(){yield this.initialize();const o=yield null===(i=this.audioContext)||void 0===i?void 0:i.decodeAudioData(t);if(void 0===o)throw Error("Could not decode audioData");const a=o.getChannelData(0);if(o.numberOfChannels>1){const t=o.getChannelData(1);for(let e=0;e<a.length;e++)a[e]=(a[e]+t[e])/2}this.active&&(yield this.stop(0)),this.isStreaming&&(yield this.stopStream()),yield this.startStream({sampleRate:o.sampleRate,preserveSegments:!0,immediate:!0});const d=(null===(s=this.decoderOptions.vad)||void 0===s?void 0:s.enabled)&&(null===(n=this.decoderOptions.vad)||void 0===n?void 0:n.controlListening),c=1e3;let l,r=0;if(d){if(e&&(yield this.setContextOptions(e)),this.decoderOptions.vad.signalSustainMillis>=c){r=c/(10/(1e4/this.decoderOptions.vad.signalSustainMillis))}else console.warn("Throttling disabled due to low (<= 1000) VAD sustain value. Server may disconnect while processing if contexts are created at high rate.");r=0}else yield this.start(e);const h=Math.round(o.sampleRate*c/1e3);for(let t=0;t<a.length;t+=h){const e=t+h;l=e>a.length?a.slice(t):a.slice(t,e),this.handleAudio(l),yield this.sleep(r)}d||(yield this.stop(0)),yield this.stopStream();return this.decoder.getSegments()}))}startStream(t){return o(this,void 0,void 0,(function*(){this.streamOptions=Object.assign(Object.assign(Object.assign({},this.streamOptions),{autoStarted:!1}),t),yield this.decoder.startStream(this.streamOptions),this.isStreaming=!0}))}stopStream(){return o(this,void 0,void 0,(function*(){this.isStreaming=!1,yield this.decoder.stopStream()}))}queueTask(t){return o(this,void 0,void 0,(function*(){const e=this.listeningPromise;return this.listeningPromise=(()=>o(this,void 0,void 0,(function*(){return yield e,t()})))(),this.listeningPromise}))}autoControlListening(t){var e;this.debug&&console.log("[BrowserClient]","autoControlListening",t),(null===(e=this.decoderOptions.vad)||void 0===e?void 0:e.controlListening)&&(t?this.active||this.start():this.active&&this.stop(0))}autoControlStream(){var t,e;return o(this,void 0,void 0,(function*(){this.audioProcessorInitialized&&this.stream&&(!(null===(t=this.decoderOptions.vad)||void 0===t?void 0:t.enabled)||this.isStreaming?!(null===(e=this.decoderOptions.vad)||void 0===e?void 0:e.enabled)&&this.isStreaming&&this.streamOptions.autoStarted&&(yield this.stopStream()):yield this.startStream({autoStarted:!0}))}))}handleStateChange(e){switch(e){case t.DecoderState.Disconnected:case t.DecoderState.Failed:this.stopStream()}}detach(){return o(this,void 0,void 0,(function*(){this.active&&(yield this.stop(0)),this.stream&&(this.stream.disconnect(),this.stream=void 0)}))}close(){var t,e,i;return o(this,void 0,void 0,(function*(){yield this.detach(),null!==this.speechlyNode&&(null===(t=this.speechlyNode)||void 0===t||t.port.close(),null===(e=this.speechlyNode)||void 0===e||e.disconnect()),void 0!==this.audioProcessor&&(null===(i=this.audioProcessor)||void 0===i||i.disconnect()),yield this.decoder.close(),this.initialized=!1}))}sleep(t){return o(this,void 0,void 0,(function*(){return new Promise((e=>setTimeout(e,t)))}))}handleAudio(t){this.isStreaming&&(this.stats.sentSamples+=t.length,this.decoder.sendAudio(t))}onStart(t){this.callbacks.contextStartedCbs.addEventListener(t)}onStop(t){this.callbacks.contextStoppedCbs.addEventListener(t)}onSegmentChange(t){this.callbacks.segmentChangeCbs.addEventListener(t)}onTranscript(t){this.callbacks.transcriptCbs.addEventListener(t)}onEntity(t){this.callbacks.entityCbs.addEventListener(t)}onIntent(t){this.callbacks.intentCbs.addEventListener(t)}onTentativeTranscript(t){this.callbacks.tentativeTranscriptCbs.addEventListener(t)}onTentativeEntities(t){this.callbacks.tentativeEntityCbs.addEventListener(t)}onTentativeIntent(t){this.callbacks.tentativeIntentCbs.addEventListener(t)}onStateChange(t){this.callbacks.stateChangeCbs.addEventListener(t)}},t.BrowserMicrophone=class{constructor(){this.muted=!1,this.initialized=!1,this.state=t.AudioSourceState.Stopped,this.debug=!1,this.stateChangeCbs=[];try{const t=window.navigator.mediaDevices.getSupportedConstraints();this.nativeResamplingSupported=!0===t.sampleRate,this.autoGainControlSupported=!0===t.autoGainControl}catch(t){this.nativeResamplingSupported=!1,this.autoGainControlSupported=!1}}onStateChange(t){this.stateChangeCbs.push(t)}initialize(){var i;return o(this,void 0,void 0,(function*(){if(this.initialized)return;if(void 0===(null===(i=window.navigator)||void 0===i?void 0:i.mediaDevices))throw this.setState(t.AudioSourceState.NoBrowserSupport),e;const n={video:!1};this.nativeResamplingSupported||this.autoGainControlSupported?n.audio={sampleRate:s,autoGainControl:this.autoGainControlSupported}:n.audio=!0;try{this.setState(t.AudioSourceState.Starting),this.mediaStream=yield window.navigator.mediaDevices.getUserMedia(n)}catch(e){throw this.setState(t.AudioSourceState.NoAudioConsent),console.error(e),c}this.initialized=!0,this.muted=!0,this.setState(t.AudioSourceState.Started)}))}setState(t){this.state!==t&&(this.debug&&console.log("[BrowserMicrophone]",this.state,"->",t),this.state=t,this.stateChangeCbs.forEach((e=>e(t))))}close(){return o(this,void 0,void 0,(function*(){if(!this.initialized)return;this.muted=!0;this.mediaStream.getTracks().forEach((t=>t.stop())),this.mediaStream=void 0,this.initialized=!1,this.setState(t.AudioSourceState.Stopped)}))}isRecording(){return!this.muted}},t.CloudDecoder=E,t.DecoderDefaultOptions=m,t.DefaultSampleRate=s,t.ErrAlreadyInitialized=d,t.ErrAlreadyStarted=X,t.ErrAlreadyStopped=R,t.ErrAppIdChangeWithoutProjectLogin=i,t.ErrDeviceNotSupported=e,t.ErrKeyNotFound=b,t.ErrNoAudioConsent=c,t.ErrNoStorageSupport=u,t.ErrNotInitialized=a,t.EventCallbacks=W,t.ListenerArray=v,t.SegmentState=n,t.StreamDefaultOptions=y,t.VadDefaultOptions=Z,t.stateToString=S,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=speechly.umd.min.js.map
